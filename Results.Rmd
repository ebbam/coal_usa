---
title: "Results to Date"
author: "Ebba Mark"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: lumen
    code_download: yes
    toc: yes
    toc_float: yes
    toc_depth: 2
    number_sections: yes
    df_print: paged
  pdf_document:
    toc: yes
    toc_depth: '2'
---
  
```{r, echo=FALSE}
knitr::opts_chunk$set(comment = NA, echo = TRUE, eval = TRUE, 
                      warning = FALSE, message = FALSE)
```

```{r, include = FALSE}
rm(list = ls())
library(tidyverse)
library(rstatix)
library(here)
library(readxl)
library(plm)
library(conflicted)
library(fixest)
library(splm)
library(spdep)
library(zoo)
library(modelsummary)
library(dotwhisker)
library(sf)
library(raster)
library(dplyr)
library(spData)
library(tmap)
library(leaflet)
library(usmap)
library(ggplot2)
library(viridis)
library(gridExtra)
library(PDMIF)
library(multcomp)
library(stargazer)
library(texreg)
library(kableExtra)
library(pander)
library(beeswarm)
conflict_prefer("select","dplyr")
conflict_prefer("extract", "texreg")
conflict_prefer("filter", "dplyr")
conflict_prefer("here", "here")
conflict_prefer("lag", "dplyr")
conflict_prefer("select", "dplyr")

# Concerns to consider [X] if resolved:
# [X] 7 LA counties are missing observations from 2005-2007
# [X] VA Counties have been excluded from samples below due to inconsistency in 
#       FIPS format between BEA and Census 
# [ ] DC is removed from spatial matrix -- might be a useful proximity to consider (urban)
```


```{r datasets, include = FALSE}
# Dataset of relevant variables for analysis
allcomp <- read_excel(here("data/allcomp_final.xlsx"))

# Unmodified lookup table to adjust FIPS codes between various standards
bea_fips_mods <- read_excel(here("data/FIPSModificationsVA.xlsx"), skip = 1, col_types = c("text", "text","text","text"))

# Create subset of coal counties (CC) only (with active mines at some point)
cclist <- unique(allcomp$fips[which(allcomp$active_mines != 0)])
allcomp_cc <- subset(allcomp, fips %in% cclist)

# Dataset including the "type" of county as found in the Typology work (Typology Work_New.Rmd)
# Merged with CC dataset
cc_cluster <- read_excel(here("data/cc_clusters_251.xlsx"))
allcomp_cc_types <- merge(allcomp_cc, cc_cluster, by = "fips", all.x = TRUE)

# Load required functions and dictionaries
source("useful_functions.R")
source("dicts.R")
source("ref_lists.R")

```

```{r}
# Summary tables
# Variables labels are NOT assigned -- need to modify dictionaries above 
# when adding or removing variables from summary tables
allcompdf <- as.data.frame(allcomp)
allcompccdf <- as.data.frame(allcomp_cc)

stargazer(allcompdf[c("active_mines" ,"uer","employed", "unemployed", 
                      "labour_force", "pop", "REE_inv","production_shorttons",
                      "realgdp","realgdp_pc", "ruc", "ruc_bin","total_taa",
                      "REE_inv_scaled_realgdp")], title = "Summary Statistics: Contiguous US Counties", 
                      covariate.labels = sum_dict)

stargazer(allcompccdf[c("active_mines" ,"uer","employed", "unemployed", 
                        "labour_force", "pop", "REE_inv","production_shorttons",
                        "realgdp","realgdp_pc", "ruc", "ruc_bin","total_taa",
                        "REE_inv_scaled_realgdp")], title = "Summary Statistics: US Coal Counties",
                        covariate.labels = sum_dict, type = "text")

stargazer(allcompdf[c("diff_uer", "mines_diff","diff_log_realgdp", 
                      "diff_log_realgdp_pc", "diff_log_employed",
                      "diff_log_unemployed", "diff_log_lf", "diff_log_pop", 
                      "REE_bin_top90") ], 
                      title = "Summary Statistics of Transformed Variables: Contiguous US Counties",
                      covariate.labels = sum_dict_trans, type = "text")

stargazer(allcompccdf[c("diff_uer", "mines_diff","diff_log_realgdp", 
                        "diff_log_realgdp_pc", "diff_log_employed",
                        "diff_log_unemployed", "diff_log_lf", "diff_log_pop", 
                        "REE_bin_top90") ], 
                        title = "Summary Statistics of Transformed Variables: US Coal Counties Subset", 
                        covariate.labels = sum_dict_trans, type = "text")

```

```{r, stationarity tests, eval = FALSE, include = FALSE}
pdf <- pdata.frame(allcomp_full, index = c("fips", "year"))
pdfcc <- pdata.frame(allcomp_cc, index = c("fips", "year"))


relvars <- c("uer","diff_uer", "realgdp", "log_realgdp", "diff_log_realgdp", 
                                     "realgdp_pc", "logrealgdp_pc", "diff_log_realgdp_pc", 
                                     "employed", "log_employed", "diff_log_employed",
                                     "unemployed", "log_unemployed", "diff_log_unemployed",
                                     "labour_force", "log_lf", "diff_log_lf", 
                                     "pop", "log_pop", "diff_log_pop")
relvars_cc <-  c("active_mines", "mines_diff","REE_inv_scaled_realgdp","REE_bin_top90", "production_shorttons", "prod_diff")

stat_tests <- data.frame(var = relvars)
stat_tests_cc <- data.frame(var = relvars_cc)

rel_tot = data.frame()
for(l in 1:nrow(stat_tests)){
  lvar = stat_tests$var[[l]]
  print(lvar)
  pval1 = purtest(eval(parse(text = paste0("pdf$",lvar, sep = ""))), pmax = 4, test = "levinlin", exo = "none")
  pval2 = purtest(eval(parse(text = paste0("pdf$",lvar, sep = ""))), pmax = 4, test = "levinlin", exo = "intercept")
  pval3 = purtest(eval(parse(text = paste0("pdf$",lvar, sep = ""))), pmax = 4, test = "levinlin", exo = "trend")
  pval4 = purtest(eval(parse(text = paste0("pdf$",lvar, sep = ""))), pmax = 4, test = "hadri", exo = "trend")
  result1 = ifelse(pval1$statistic$p.value <= 0.001, pval1$statistic$alternative, paste0("NOT",pval1$statistic$alternative))
  result2 = ifelse(pval2$statistic$p.value <= 0.001, pval2$statistic$alternative, paste0("NOT",pval2$statistic$alternative))
  result3 = ifelse(pval3$statistic$p.value <= 0.001, pval3$statistic$alternative, paste0("NOT",pval3$statistic$alternative))
  rel_tot <- rbind(rel_tot,
                   c(lvar, pval1$statistic$method, pval1$statistic$p.value, result1),
                   c(lvar, pval2$statistic$method, pval2$statistic$p.value, result2),
                   c(lvar, pval3$statistic$method, pval3$statistic$p.value, result3))
}


 for(l in 1:nrow(stat_tests_cc)){
  lvar = stat_tests_cc$var[[l]]
  print(lvar)
  pvali = purtest(eval(parse(text = paste0("pdfcc$",lvar, sep = ""))), pmax = 4, exo = "intercept", test = "hadri")
  pvalt = purtest(eval(parse(text = paste0("pdfcc$",lvar, sep = ""))), pmax = 4, exo = "trend", test = "hadri")
  resulti = ifelse(pvali$statistic$p.value <= 0.001, pvali$statistic$alternative, paste0("NOT",pvali$statistic$alternative))
  resultt = ifelse(pvalt$statistic$p.value <= 0.001, pvalt$statistic$alternative, paste0("NOT",pvalt$statistic$alternative))
  res_veci = c(lvar, pvali$statistic$method, pvali$statistic$p.value, resulti)
  res_vect = c(lvar, pvalt$statistic$method, pvalt$statistic$p.value, resultt)
  rel_tot <- rbind(rel_tot, res_veci, res_vect)
 }

purtest(pdf$uer, pmax = 4, test = "madwu", exo = "intercept")
pval_int$statistic$alternative
pander(rel_tot)

rel_cips_tot = data.frame()
for(l in 1:nrow(stat_tests)){
  lvar = stat_tests$var[[l]]
  print(lvar)
  pval_int = cipstest(eval(parse(text = paste0("pdf$",lvar, sep = ""))), type = "trend")
  pval_trend = purtest(eval(parse(text = paste0("pdf$",lvar, sep = ""))), pmax = 4, test = "hadri", exo = "trend")
  result_int = ifelse(pval_int$statistic$p.value <= 0.001, pval_int$statistic$alternative, paste0("NOT",pval_int$statistic$alternative))
  result_trend = ifelse(pval_trend$statistic$p.value <= 0.001, pval_trend$statistic$alternative, paste0("NOT",pval_trend$statistic$alternative))
  res_vec = c(c(lvar, pval_int$statistic$method, pval_int$statistic$p.value, result_int),
              c(lvar, pval_trend$statistic$method, pval_trend$statistic$p.value, result_trend))
  rel_cips_tot <- rbind(rel_cips_tot, res_vec)
}

cipstest(pdf$uer, type = "none")
pvar(pdf)

```


```{r, include = FALSE}
# Create adjacency matrix for spatial model
##############################################################
# Import adjacency matrix from US Census Bureau: 
# https://www.census.gov/programs-surveys/geography/library/reference/county-adjacency-file.html
xmat1 <- read.csv("data/county_adjacency.txt", sep="\t", stringsAsFactors = FALSE, header = FALSE)

# Retain only columns with FIPS codes of each county (V2) and its neighbors (V4)
xmat1 <- xmat1[,c("V2","V4")]

# Replace NA values in V2 such that each row is a pair of neighbors
xmat1$V2 <- na.locf(xmat1$V2)

# Convert from integer to character fips code for appropriate matching
xmat1$V2 <- lapply(xmat1$V2, function(x) sapply(x, fips_format))
xmat1$V4 <- lapply(xmat1$V4, function(x) sapply(x, fips_format))

# Create lookup table to convert VA FIPS codes
getfips <- bea_fips_mods$`BEA FIPS`
names(getfips) <- bea_fips_mods$FIPS

xmat1[xmat1 == "46113"] <- "46102"
xmat1[xmat1 == "51515"] <- "51019"
xmat1$V2 <- lapply(xmat1$V2, function(x) ifelse(x %in% bea_fips_mods$FIPS, getfips[x], x))
xmat1$V4 <- lapply(xmat1$V4, function(x) ifelse(x %in% bea_fips_mods$FIPS, getfips[x], x))

# Removes Alaska, Hawaii, DC, PR, Guam, American Samoa
xmat1 <- subset(xmat1, substr(V2, 1, 2) != "60" & 
                  substr(V2, 1, 2) != "66" &
                  substr(V2, 1, 2) != "69" &
                  substr(V2, 1, 2) != "72" &
                  substr(V2, 1, 2) != "78" &
                  substr(V2, 1, 2) != "15" &
                  substr(V2, 1, 2) != "02")

LA_list <- c(LA_list_missing, "11001")
xmat1 <- subset(xmat1, !(V2 %in% LA_list) & !(V4 %in% LA_list))

length(unique(xmat1$V2))
#as.list(unique(xmat1$V2[which(!(xmat1$V2 %in% allcomp$fips))]))

# Unnest list elements for easier manipulation
xmat1 <- unnest(xmat1)
# Create a list of each unique FIPS code for matching
fipslist <- unique(xmat1$V2)

# Subset dataframe to only include FIPS present in the distance matrix
allcomp_nomissing <- subset(allcomp, fips %in% fipslist)
#allcomp_nomissing <- subset(allcomp_nomissing, fips != "51770")
allcomp_full <- allcomp_nomissing %>%
  arrange(fips) %>%
  select(fips,year,everything())

# # Spatial matrix includes counties that are not represented in dataset
# # Create list of fips in spatial matrix not in coal brief
# extraspat <- sapply(fipslist, function(x) !(x %in% allcomp$fips))
# extras <- fipslist[extraspat]

# Remove the fips in above list from spatial matrix to ensure fips match dataset perfectly
# # 51770 missing neighbors - remove for testing purposes ATM
# xmat <- subset(xmat1, !(V2 %in% extras) & !(V4 %in% extras) & V2 != "51770")

xmatfips <- unique(xmat1$V2)

# Create an empty (all cells = 0) n x n distance matrix with n = no of FIPS codes/counties
fmat <- matrix(data=0, nrow = length(xmatfips), ncol = length(xmatfips), dimnames = list(xmatfips,xmatfips))

# Iterate through xmatfips, populating matrix with 1 if two counties are neighbors
# Census bureau lists counties as neighbors of itself so the loop will fill cell 
# with 0 for row-pair that lists a county as a neighbor of itself
for(i in 1:nrow(xmat1)){
  a = as.character(xmat1$V2[i])
  b = as.character(xmat1$V4[i])
  if(identical(a,b)){fmat[a,b] <- 0}else{fmat[a,b] <- 1}
}

# Row standardises the distance matrix
fmat <- fmat/rowSums(fmat)
sum(is.na(fmat))
dim(fmat)

# Creates listw object for use in splm package
fmatlw <- mat2listw(fmat, style = "W")

# Also a test for errors
testfmatcdg <- listw2dgCMatrix(fmatlw)

# Sanity checks
### Ensure panel is balanced
is.pbalanced(allcomp_full)
### No NAs
sum(is.na(fmatlw))

```
# FIXEST regression results
*Overall Research Question: Do various indicators for changes in coal activity impact various county-level employment indicators?*

Employs standard two-way fixed effects panel regressions with county-clustered standard errors to a panel dataset of 3,072 contiguous counties observed between 2002-2019.

## Employment variables regressed on various measures of coal activity {.tabset}
### Change in active mines
**Results:**

1. Models 1: Significant change in unemployment rate in time t (in expected direction). Impact is near zero (albeit consistent sign as in t) in t+1 and changes sign in t+2 indicating a level effect as opposed to a growth effect. A one-unit decrease (increase) in active mines is associated with an increase (decrease) in the unemployment rate of 0.06 percentage points, negligible change in t+1 of the same direction, with a sign change and decrease(boost) of 0.03 percentage points. 1% significance level in time t. Indicates a non-growth effect with initial shock in time t (potentially t+1) but correcting again in t+2. (same conclusion for subset of coal counties).

2. Models 2/3: Change in employed/unemployed persons is also significant and in the expected direction. A one-unit increase in active mines is associated with a 0.12% increase in the total number of employed persons in time t (5% significance level) and 0.17% in time t+1 at the 1% significance level. (same conclusion for subset of coal counties)

3. Models 4: Change in labour force is only significant in t+1 indicating that individuals might leave the labour force following a mine closure. Though the result is very small... (same conclusion for subset of coal counties)

4. Models 5: Change in population is negligible (both in significance and magnitude). (same conclusion for subset of coal counties)

```{r level indicators}

# Level UER and level mines with various lags
lev22 <- feols(uer ~ l(active_mines, -2:0) + lag_mines + lag_mines2 + log_realgdp_pc | 
               fips + year, allcomp, panel.id = ~fips+year, se = 'twoway')
lev33 <- feols(uer ~ l(active_mines, -3:0) + lag_mines + lag_mines2 + lag_mines3 + log_realgdp_pc | 
               fips + year, allcomp, panel.id = ~fips+year, se = 'twoway')
lev03 <- feols(uer ~ active_mines + lag_mines +lag_mines2 + lag_mines3 + log_realgdp_pc | 
               fips + year, allcomp, se = 'twoway')
lev02 <- feols(uer ~ active_mines + lag_mines +lag_mines2 + log_realgdp_pc | 
               fips + year, allcomp, se = 'twoway')

# Level UER and mine levels on coal county subset
lev22cc <- feols(uer ~ l(active_mines, -2:0) + lag_mines + lag_mines2 + log_realgdp_pc | 
               fips + year, allcomp_cc, panel.id = ~fips+year, se = 'twoway')
lev33cc <- feols(uer ~ l(active_mines, -3:0) + lag_mines + lag_mines2 + lag_mines3 + log_realgdp_pc | 
               fips + year, allcomp_cc, panel.id = ~fips+year, se = 'twoway')
lev03cc <- feols(uer ~ active_mines + lag_mines +lag_mines2 + lag_mines3 + log_realgdp_pc | 
               fips + year, allcomp_cc, se = 'twoway')
lev02cc <- feols(uer ~ active_mines + lag_mines +lag_mines2 + log_realgdp_pc | 
               fips + year, allcomp_cc, se = 'twoway')
etable(lev03, lev22, lev33, lev03cc, lev22cc, lev33cc, order = c("active_mines,3", "active_mines,2", "active_mines,1", "Active Mines", "log_realgdp_pc"))

# Level mines and log emp indicators
lev_emplog <- feols(log_employed ~ active_mines + lag_mines + lag_mines2 + log_realgdp + log_pop | 
               fips + year, allcomp, se = 'twoway')
lev_unemplog <- feols(log_unemployed ~ active_mines + lag_mines + lag_mines2 + log_realgdp + log_pop | 
               fips + year, allcomp, se = 'twoway')
lev_lflog <- feols(log_lf ~ active_mines + lag_mines + lag_mines2 + log_realgdp + log_pop| 
               fips + year, allcomp, se = 'twoway')
lev_poplog <- feols(log_pop ~ active_mines + lag_mines + lag_mines2 + log_realgdp | 
               fips + year, allcomp, se = 'twoway')

etable(lev02, lev_emplog, lev_unemplog, lev_lflog, lev_poplog)

# Levels of everything
lev_emp <- feols(employed ~ active_mines + lag_mines + lag_mines2 + log_realgdp + log_pop | 
               fips + year, allcomp, se = 'twoway')
lev_unemp <- feols(unemployed ~ active_mines + lag_mines + lag_mines2 + log_realgdp + log_pop | 
               fips + year, allcomp, se = 'twoway')
lev_lf <- feols(labour_force ~ active_mines + lag_mines + lag_mines2 + log_realgdp + log_pop | 
               fips + year, allcomp, se = 'twoway')
lev_pop <- feols(pop ~ active_mines + lag_mines + lag_mines2 + log_realgdp | 
               fips + year, allcomp, se = 'twoway')
etable(lev_emp, lev_unemp, lev_lf, lev_pop)

# log dependent variables first-difference independent variables

uer_diff <- feols(uer ~ mines_diff + lag_diff + lag_diff2 + log_realgdp_pc | 
               fips + year, allcomp, se = 'twoway')
log_emp <- feols(log_employed ~ mines_diff + lag_diff + lag_diff2 + log_realgdp + log_pop | 
               fips + year, allcomp, se = 'twoway')

log_unemp <- feols(log_unemployed ~ mines_diff + lag_diff + lag_diff2 + log_realgdp + log_pop | 
               fips + year, allcomp, se = 'twoway')
log_lf <- feols(log_lf ~ mines_diff + lag_diff + lag_diff2 + log_realgdp + log_pop | 
               fips + year, allcomp, se = 'twoway')
log_pop <- feols(log_pop ~ mines_diff + lag_diff + lag_diff2 + log_realgdp | 
               fips + year, allcomp, se = 'twoway')
etable(uer_diff, log_emp, log_unemp, log_lf, log_pop)

```
# Regressions without combined time periods

The coefficient estimates are the same in each of these models isolating each variable.
```{r}

etable("t" = feols(diff_uer ~ mines_diff + diff_log_realgdp_pc | fips + year, allcomp, se = 'twoway'),
       "t-1" = feols(diff_uer ~ lag_diff + diff_log_realgdp_pc | fips + year, allcomp, se = 'twoway'),
       "t-2" = feols(diff_uer ~ lag_diff2 + diff_log_realgdp_pc | fips + year, allcomp, se = 'twoway'),
       "t-3" = feols(diff_uer ~ lag_diff3 + diff_log_realgdp_pc | fips + year, allcomp, se = 'twoway'),
       "t" = feols(diff_uer ~ mines_diff + diff_log_realgdp_pc | fips + year, allcomp_cc, se = 'twoway'),
       "t-1" = feols(diff_uer ~ lag_diff + diff_log_realgdp_pc | fips + year, allcomp_cc, se = 'twoway'),
       "t-2" = feols(diff_uer ~ lag_diff2 + diff_log_realgdp_pc | fips + year, allcomp_cc, se = 'twoway'),
       "t-3" = feols(diff_uer ~ lag_diff3 + diff_log_realgdp_pc | fips + year, allcomp_cc, se = 'twoway'),tex= TRUE,
       signifCode = c(`***` = 0.001, `**` = 0.01, `*` = 0.05, . = 0.1))

```


```{r}
# Regresses the change in unemployment rate, employed person, unemployed 
# persons, labour force, population on change in mines and two time lags using 
# full set of 3,079 contiguous US counties. 

FE_diffuer <- as.formula("diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc | fips + year")
FE_negdiffuer <- as.formula("neg_diffuer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc | fips + year")
FE_negdiffuer3 <- as.formula("neg_diffuer ~ mines_diff + lag_diff + lag_diff2 +lag_diff3 + diff_log_realgdp_pc | fips + year")

es <- feols(FE_negdiffuer, allcomp_full, panel.id = ~fips+year, se = 'twoway')
es_cc <- feols(FE_negdiffuer, allcomp_cc, panel.id = ~fips+year, se = 'twoway')
es3 <- feols(FE_negdiffuer3, allcomp_full, panel.id = ~fips+year, se = 'twoway')
es3_cc <- feols(FE_negdiffuer3, allcomp_cc, panel.id = ~fips+year, se = 'twoway')
es_2neg <- feols(neg_diffuer ~ l(mines_diff, -2:0) + lag_diff + lag_diff2 + diff_log_realgdp_pc | 
               fips + year, allcomp_full, panel.id = ~fips+year, se = 'twoway')
es_3neg <- feols(neg_diffuer ~ l(mines_diff, -3:0) + lag_diff + lag_diff2 + lag_diff3 + diff_log_realgdp_pc | 
               fips + year, allcomp_full, panel.id = ~fips+year, se = 'twoway')
es_2negcc <- feols(neg_diffuer ~ l(mines_diff, -2:0) + lag_diff + lag_diff2 + diff_log_realgdp_pc | 
               fips + year, allcomp_cc, panel.id = ~fips+year, se = 'twoway')
es_3negcc <- feols(neg_diffuer ~ l(mines_diff, -3:0) + lag_diff + lag_diff2 + lag_diff3 + diff_log_realgdp_pc | 
               fips + year, allcomp_cc, panel.id = ~fips+year, se = 'twoway')

etable(es, es_cc, es3, es3_cc, es_2neg, es_2negcc, es_3neg, es_3negcc)

fill_colors <- c(NA, "#39568CFF", "#95D840FF")
line_colors <- c(NA, "#440154FF", "#287D8EFF")
setFixest_coefplot(pt.join = TRUE, ci.join = FALSE, ci.fill = TRUE, ci.col = fill_colors, 
                   pt.col = line_colors, pt.pch = c(0, 19, 25), pt.bg = line_colors,
                   pt.cex = 1, ci.fill.par = list(col = fill_colors, alpha = 0.3), 
                   ci.lty = "dashed", ref.line = TRUE, ref.line.par = list(v = 4, col = "gray", lty = "solid"),
                   grid = TRUE, grid.par = list(vert = FALSE, lwd = 1), dict = plot_dict)

es_blank <- feols(diff_uer ~ l(mines_diff, -3:0) + lag_diff + lag_diff2 + lag_diff3 + diff_log_realgdp_pc | 
               fips + year, allcomp_cc, panel.id = ~fips+year, se = 'twoway')

coefplot(list(es_3negcc, es3, es3_cc), drop = c('diff_log_realgdp_pc'), xlim.add = c(0,0.001))
coefplot(list(es_blank, es_2neg, es_2negcc), drop = c('diff_log_realgdp_pc'), xlim.add = c(0,0.06))
coefplot(list(es_blank, es_3neg, es_3negcc), drop = c('diff_log_realgdp_pc'), xlab = "Years since negative change in active mines")

plot(NULL ,xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("topleft", legend = c("US Counties", "Coal Counties Only", "95% Confidence Interval", "95% Confidence Interval"), 
  col = c("#440154FF", "#287D8EFF", "#39568C4D", "#95D8404D"), 
  pt.bg = c("#440154FF", "#287D8EFF", NA, NA),
  pch = c(19,25,15,15),
  bty = "n", 
  pt.cex = c(1.5,1.5,3.5,3.5), 
  cex = 1, 
  text.col = "black", 
  ncol = 2,
  lty = c("solid", "solid", NA, NA),
  y.intersp = 1.5
  )
```

```{r, include = FALSE}

FE_diffuer3 <- as.formula("diff_uer ~ mines_diff + lag_diff + lag_diff2 +lag_diff3 + diff_log_realgdp_pc | fips + year")

es_ccpos <- feols(FE_diffuer, allcomp_cc, panel.id = ~fips+year, se = 'twoway')
es3pos <- feols(FE_diffuer3, allcomp, panel.id = ~fips+year, se = 'twoway')
es3_ccpos <- feols(FE_diffuer3, allcomp_cc, panel.id = ~fips+year, se = 'twoway')
es_2negpos <- feols(diff_uer ~ l(mines_diff, -2:0) + lag_diff + lag_diff2 + diff_log_realgdp_pc | 
               fips + year, allcomp, panel.id = ~fips+year, se = 'twoway')
es_3negpos <- feols(diff_uer ~ l(mines_diff, -3:0) + lag_diff + lag_diff2 + lag_diff3 + diff_log_realgdp_pc | 
               fips + year, allcomp, panel.id = ~fips+year, se = 'twoway')
es_2negccpos <- feols(diff_uer ~ l(mines_diff, -2:0) + lag_diff + lag_diff2 + diff_log_realgdp_pc | 
               fips + year, allcomp_cc, panel.id = ~fips+year, se = 'twoway')
es_3negccpos <- feols(diff_uer ~ l(mines_diff, -3:0) + lag_diff + lag_diff2 + lag_diff3 + diff_log_realgdp_pc | 
               fips + year, allcomp_cc, panel.id = ~fips+year, se = 'twoway')

etable(es3pos, es_2negpos, es_3negpos, es3_ccpos, es_2negccpos, es_3negccpos, 
       order = c("mines_diff,3", "mines_diff,2", "mines_diff,1", "Active Mines", "lag_diff3"))

```
### Change in active mines interacted with rural (1) vs. urban (0)
*Research Question: Are changes in the amount of active mines associated with changes in the unemployment rate, conditional on whether a county is rural or not? Ie. do changes in active mines impact rural and urban counties differently?*

Results:

1. Models 6: Including rural = 1 interaction term does not add much information. Likely that an already small unemployment rate change disaggregated by county type weakens ability to detect an impact?

```{r}
# First (second) model uses set of all US counties (subset of coal counties only).

etable("Model 6_i" = feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 +  mines_diff:ruc_bin + lag_diff:ruc_bin + lag_diff2:ruc_bin + diff_log_realgdp_pc | 
               fips + year, allcomp, se = 'twoway'),
       "Model 6_i CC" = feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 +  mines_diff:ruc_bin + lag_diff:ruc_bin + lag_diff2:ruc_bin + diff_log_realgdp_pc  | 
               fips + year, allcomp_cc, se = 'twoway'))

```

### Asymmetric treatment attempt
*Research Question: What is the impact of a positive (negative) change in active mines on county-level unemployment rate?*

The point estimates indicate a potential asymmetric treatment (mine closures lead to a larger change in unemployment rate as compared to the opening of a mine) effect but is not statistically significant.

Potential interesting result shows that the coefficient on change in mines is restricted to NEGATIVE changes. Essentially, this evidence shows that positive changes in active mines do not provide "windfall" employment, indicating that the solution is not to RETAIN or re-invigorate the mining sector.

```{r}
main <- feols(FE_diffuer, allcomp, se = 'twoway')
main_cc <- feols(FE_diffuer, allcomp_cc, se = 'twoway')
allcomp$pos_difflag <- ifelse(allcomp$lag_diff >= 0, 1, 0)
allcomp$pos_difflag2 <- ifelse(allcomp$lag_diff2 >= 0, 1, 0)
allcomp$neg_difflag <- ifelse(allcomp$lag_diff < 0, 1, 0)
allcomp$neg_difflag2 <- ifelse(allcomp$lag_diff2 < 0, 1, 0)

# Uses binary indicators for whether a change in active mines was positive (or zero) 
# versus negative.
# Below uses set of all contiguous US counties
model_7_neg= feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 + neg_diff:mines_diff + 
                               neg_difflag:lag_diff + neg_difflag2:lag_diff2 + diff_log_realgdp_pc | 
                               fips + year, allcomp, se = 'twoway')

model_8_pos = feols(diff_uer ~ mines_diff + lag_diff +lag_diff2 + pos_diff:mines_diff + 
                               pos_difflag:lag_diff + pos_difflag2:lag_diff2 + diff_log_realgdp_pc | 
                            fips + year, allcomp, se = 'twoway')

model_9_both = feols(diff_uer ~ neg_diff:mines_diff + neg_difflag:lag_diff + neg_difflag2:lag_diff2 + pos_diff:mines_diff + pos_difflag:lag_diff + pos_difflag2:lag_diff2 + diff_log_realgdp_pc | fips + year, allcomp, se = 'twoway')

etable(model_7_neg, model_8_pos, model_9_both, signifCode = c(`***` = 0.001, `**` = 0.01, `*` = 0.05, . = 0.1))
etable(model_9_both)

# Mines_diff is different from zero (statistically significant at the .1% level) (-0.056%)
glht(main, linfct = "mines_diff  = 0") %>% summary
glht(main, linfct = "mines_diff + lag_diff + lag_diff2 = 0") %>% summary

#glht(main, linfct = mcp(tension = c("mines_diff  = 0", "mines_diff + lag_diff + lag_diff2 = 0")))

# Mines_diff + mines_diff:neg_diff is different from zero (statistically significant at the 1% level)
# Higher coefficient value than in broader model (-0.078%)
glht(model_7_neg, linfct = "mines_diff + mines_diff:neg_diff = 0") %>% summary
glht(model_7_neg, linfct = "mines_diff + mines_diff:neg_diff + lag_diff + lag_diff:neg_difflag + lag_diff2 + lag_diff2:neg_difflag2 = 0") %>% summary

# Mines_diff and pos_diff is different from zero although not statistically significant and at a much lower magnitude! (-0.021%)
glht(model_8_pos, linfct = "mines_diff + mines_diff:pos_diff = 0") %>% summary
glht(model_8_pos, linfct = "mines_diff + mines_diff:pos_diff + lag_diff + lag_diff:pos_difflag + lag_diff2 + lag_diff2:pos_difflag2 = 0") %>% summary
```


```{r, eval = FALSE, include = FALSE}
allcomp_cc$pos_difflag <- ifelse(allcomp_cc$lag_diff >= 0, 1, 0)
allcomp_cc$pos_difflag2 <- ifelse(allcomp_cc$lag_diff2 >= 0, 1, 0)
allcomp_cc$neg_difflag <- ifelse(allcomp_cc$lag_diff < 0, 1, 0)
allcomp_cc$neg_difflag2 <- ifelse(allcomp_cc$lag_diff2 < 0, 1, 0)

# Below uses subset of coal counties only.
model_7_neg_cc = feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 + neg_diff:mines_diff + 
                               neg_difflag:lag_diff + neg_difflag2:lag_diff2 + diff_log_realgdp_pc | 
                         fips + year, allcomp_cc, se = 'twoway')
model_8_pos_cc = feols(diff_uer ~ mines_diff + lag_diff +lag_diff2 + pos_diff:mines_diff + 
                               pos_difflag:lag_diff + pos_difflag2:lag_diff2 + diff_log_realgdp_pc |
                         fips + year, allcomp_cc, se = 'twoway')
model_9_both_cc =feols(diff_uer ~ neg_diff:mines_diff + neg_diff:lag_diff + neg_diff:lag_diff2 +
                         pos_diff:mines_diff + pos_diff:lag_diff + pos_diff:lag_diff2 + 
                         diff_log_realgdp_pc | fips + year, allcomp_cc, se = 'twoway')

etable(model_7_neg_cc, model_8_pos_cc, model_9_both_cc)

# Mines_diff is different from zero (statistically significant at the .1% level) (-0.041%)
glht(main_cc, linfct = "mines_diff  = 0") %>% summary
# Mines_diff + mines_diff:neg_diff is different from zero (statistically significant at the 1% level)
# Higher coefficient value than in broader model (-0.061%)
glht(model_7_neg_cc, linfct = "mines_diff + mines_diff:neg_diff = 0") %>% summary
glht(model_7_neg_cc, linfct = "mines_diff + mines_diff:neg_diff + lag_diff + lag_diff:neg_difflag + lag_diff2 + lag_diff2:neg_difflag2 = 0") %>% summary
# Mines_diff and pos_diff is different from zero although not statistically significant and at a much lower magnitude! (-0.009%)
glht(model_8_pos_cc, linfct = "mines_diff + mines_diff:pos_diff = 0") %>% summary
glht(model_8_pos_cc, linfct = "mines_diff + mines_diff:pos_diff + lag_diff + lag_diff:pos_difflag + lag_diff2 + lag_diff2:pos_difflag2 = 0") %>% summary
```
### Incorporating county types
The typology work is not included in this set of results. The following regressions take the set of 251 coal counties (as defined above) and subset into three groups depending on whether they are Type 1, 2, or 3 counties (see summary table in paper draft).

Results:

1. Main result is from CC Rural Model. Shows that the only type of county with statistically significant impacts from changes in active mines is the Type 1 rural, low-income, smaller, lower percentage of college education, lower female LFPR, etc. The effect detected here follows the same behavior as that in Model 1 and Model 1 CC.

```{r, running Fixest regressions with county type}
#| fig.width: 9
#| fig.height: 9
main <- feols(FE_diffuer, allcomp, se = 'twoway')
main_cc <- feols(FE_diffuer, allcomp_cc, se = 'twoway')

##### Run regressions from previous section incorporating the type of county. ########
# The county types (1,2,3) are derived from the clustering typology exercise outlined in the paper draft.
# Types are as follows: (rural:1; medium:2, urban:3)

cc_urbandf <- allcomp_cc_types %>% subset(type == 1)
cc_mediumdf <- allcomp_cc_types %>% subset(type == 2)
cc_ruraldf <- allcomp_cc_types %>% subset(type == 3)

cc_rural = feols(FE_diffuer, cc_ruraldf, se = "twoway")
cc_medium = feols(FE_diffuer, cc_mediumdf, se = "twoway")
cc_urban = feols(FE_diffuer, cc_urbandf, se = "twoway")

rural_2neg <- feols(diff_uer ~ l(mines_diff, -1:0) + lag_diff + lag_diff2 + lag_diff3 + diff_log_realgdp_pc | 
               fips + year, cc_ruraldf, panel.id = ~fips+year, se = 'twoway')
medium_2neg <- feols(diff_uer ~ l(mines_diff, -1:0) + lag_diff + lag_diff2 + lag_diff3 + diff_log_realgdp_pc | 
               fips + year, cc_mediumdf, panel.id = ~fips+year, se = 'twoway')
urban_2neg <- feols(diff_uer ~ l(mines_diff, -1:0) + lag_diff + lag_diff2 + lag_diff3 +diff_log_realgdp_pc | 
               fips + year, cc_urbandf, panel.id = ~fips+year, se = 'twoway')


fill_colors <- c("#39568CFF", "#95D840FF", "#eb7134")
line_colors <- c("#440154FF", "#287D8EFF", "#eb7134")
setFixest_coefplot(pt.join = TRUE, pt.join.par = list(lwd = 2, lty = c("solid", "dashed", "dashed")), 
                   ci.join = TRUE, ci.join.par = list(lty = c("dashed", "blank", "blank"), lwd = 0.5, col = line_colors), ci.fill = TRUE, ci.col = fill_colors, 
                   pt.col = line_colors, pt.pch = c(25, 23, 19), pt.bg = line_colors,
                   pt.cex = 1, ci.fill.par = list(col = fill_colors, alpha = 0.1), ci.lwd = 0.5, 
                   ci.lty = "blank", ref.line = TRUE, ref.line.par = list(v = 2, col = "gray", lty = "solid"),
                   grid = TRUE, grid.par = list(vert = FALSE, lwd = 1), dict = plot_dict, sep = 0)

coefplot(list(rural_2neg, medium_2neg, urban_2neg),drop = c('diff_log_realgdp_pc'), xlab = "Years since negative change in active mines")
legend("topright", legend = c("Type 1", "Type 2", "Type 3"), col = c( "#eb7134","#287D8EFF","#440154FF"), pt.bg= c( "#eb7134","#287D8EFF","#440154FF"), pch = c(19, 23, 25), cex = 1, 
  text.col = "black", lty = c("dashed", "dashed", "solid"))

# coefplot(list(rural_2neg),drop = c('diff_log_realgdp_pc'))
# coefplot(list(medium_2neg),drop = c('diff_log_realgdp_pc'))
# coefplot(list(urban_2neg),drop = c('diff_log_realgdp_pc'))

etable("CC Urban" = cc_urban, "CC Medium" = cc_medium, "CC Rural" = cc_rural, urban_2neg, medium_2neg, rural_2neg, order = c("mines_diff,1", "Change Active Mines"))

 model_types <- list(
  "Rural Type 1 Counties" = cc_rural,
  "Medium Type 2 Counties" = cc_medium,
  "Urban Type 3 Counties" = cc_urban)

 
test <- allcomp_cc_types %>% 
  group_by(fips) %>% 
  summarize(m1 = length(unique(mines_diff)), m1mean = mean(mines_diff),
            m2 = length(unique(lag_diff)), m2mean = mean(lag_diff),
            m3 = length(unique(lag_diff2)), m3mean = mean(lag_diff2))

test2 <- subset(test, (m1 == 1 & m1mean == 0) | (m2 == 1 & m2mean == 0) | (m3 == 1 & m3mean == 0))
const_fips <- unique(test2$fips)
allcomp_pdmif <- subset(allcomp_cc_types, !(fips %in% const_fips))

etable("REE Model Rural" = feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 + mines_diff:REE_bin_top90 +
                             lag_diff:REE_bin_top90 + lag_diff2:REE_bin_top90 + REE_bin_top90 + diff_log_realgdp_pc | fips + year, cc_ruraldf,  se = 'twoway'),
"REE Model Medium" = feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 + mines_diff:REE_bin_top90 +
                             lag_diff:REE_bin_top90 + lag_diff2:REE_bin_top90 + REE_bin_top90 + diff_log_realgdp_pc | fips + year, cc_mediumdf,  se = 'twoway'),
            "REE Model Urban" = feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 + mines_diff:REE_bin_top90 +
                             lag_diff:REE_bin_top90 + lag_diff2:REE_bin_top90 + REE_bin_top90 + diff_log_realgdp_pc | fips + year, cc_urbandf,  se = 'twoway'))
```


```{r, running Fixest regressions with county type}
## Incorporating county types using PDMIF
# X can only have p columns where p = explanatory variables.

data4x <- select(allcomp_pdmif, c(mines_diff, lag_diff, lag_diff2, diff_log_realgdp_pc))
test <- as.matrix(data4x)
data4y <- select(allcomp_pdmif, c(year, fips, diff_uer))
yrs <- as.list(unique(data4y$year))
fps <- as.list(unique(data4y$fips))
data4y <- matrix(data = data4y$diff_uer, 18, 236, dimnames = list(yrs, fps))
groupmem <- allcomp_pdmif %>%
  group_by(fips) %>%
  summarize(type = unique(type))
groupmem <- data.frame(groupmem[,-1], row.names = groupmem$fips)

pdmif <- PDMIFLING(X = test, Y = data4y, Membership = groupmem, NGfactors = 1, NLfactors = c(2,2,2), Maxit = 30, tol = 0.01)

HYPTEST(pdmif$Coefficients,data.frame(c(0,1),c(-1,2)),pdmif$Se,"two",c(1,3),c(1,2))
dim(pdmif$Coefficients)
length(pdmif$GlobalFactors)
dim(pdmif$GlobalLoadings)
dim(pdmif$GroupFactors)
pdmif$GroupLoadings
pdmif$Coefficients %>% View()
colnames(pdmif$Coefficients) <- colnames(data4y)

length(pdmif$Coefficients[1,which(groupmem$type == 3)])
length(pdmif$Coefficients[1,which(groupmem$type == 2)])
length(pdmif$Coefficients[1,which(groupmem$type == 1)])
pdmif$Coefficients[which(groupmem$type == 3)]

# pdmifshort <- pdmif$Coefficients[,colnames(pdmif$Coefficients)!="30003"]
# groupmemshort <- as.data.frame(groupmem[rownames(groupmem) != "30003",])
# names(groupmemshort) <- "type"

beeswarm(c(pdmif$Coefficients[1,],pdmif$Coefficients[2,],pdmif$Coefficients[3,]) ~ c(rep(1,236),rep(2,236), rep(3,236)),
          #col = c(rgb(0.25, 0.63, 1, 0.75), rgb(1, 0.88, 0.6, 0.75), rgb(0.97, 0.43, 0.37, 0.75)),
          pwcol = c(rep(groupmem$type), rep(groupmem$type),rep(groupmem$type)),
          pch=19, method="swarm", cex=0.5, corral="wrap", ylab="Value", xlab=NA, labels=c("mines_diff","lag_diff","lag_diff2"))

legend("topright", legend = c("1", "2", "3"),
       col = 1:3, pch = 19)

# allcomp %>% filter(fips == "30003") %>% ggplot(aes(y = uer, x = year))+
#   geom_line()+
#   geom_line(aes(y = mines_diff))


allcomp_cc_typespdmif <- subset(allcomp_cc_types, fips %in% allcomp_pdmif$fips)

urban_pdmif <- allcomp_cc_typespdmif %>% subset(type == 1)
medium_pdmif <- allcomp_cc_typespdmif %>% subset(type == 2)
rural_pdmif <- allcomp_cc_typespdmif %>% subset(type == 3)

cc_ruralpdmif = feols(FE_diffuer, rural_pdmif, se = "twoway")
cc_mediumpdmif = feols(FE_diffuer, medium_pdmif, se = "twoway")
cc_urbanpdmif = feols(FE_diffuer, urban_pdmif, se = "twoway")

etable(cc_rural, cc_ruralpdmif, cc_medium, cc_mediumpdmif, cc_urban, cc_urbanpdmif)
```

### Binary change in mines
Likely to exclude this estimation as results are not significant.
```{r}
# ----- on binary indicator for whether the change in mines is negative from the previous year
allcomp$lag_closure2[which(is.na(allcomp$lag_closure2))] <- 0
allcomp_cc$lag_closure2[which(is.na(allcomp_cc$lag_closure2))] <- 0
etable("Model 10" = feols(diff_uer ~ mine_closure + lag_closure + lag_closure2 + diff_log_realgdp_pc | fips + year, allcomp, se = 'twoway'), "Model 11" = feols(diff_uer ~ mine_closure + lag_closure + lag_closure2 + mine_closure:ruc_bin +
               lag_closure:ruc_bin + lag_closure2:ruc_bin + diff_log_realgdp_pc | fips + year, allcomp, se = 'twoway'), "Model 10 CC" = feols(diff_uer ~ mine_closure + lag_closure + lag_closure2 + diff_log_realgdp_pc | fips + year, allcomp_cc, se = 'twoway'),"Model 11 CC" = feols(diff_uer ~ mine_closure + lag_closure + lag_closure2 + mine_closure:ruc_bin +
               lag_closure:ruc_bin + lag_closure2:ruc_bin + diff_log_realgdp_pc | fips + year, allcomp_cc, se = 'twoway'))
```

### Change in coal production
Likely to exclude this estimation as results are not significant.
```{r, eval = FALSE, include = FALSE}
# ----- on change in county-level coal production in short tons
etable("Model 12" = feols(diff_uer ~ prod_diff + lag_prod_diff + diff_log_realgdp_pc | fips + year, allcomp, se = 'twoway'),
       "Model 12 CC" = feols(diff_uer ~ prod_diff + lag_prod_diff + diff_log_realgdp_pc | fips + year, allcomp_cc, se = 'twoway'),
       "Model 13" = feols(diff_employed ~ prod_diff + lag_prod_diff + log_realgdp + log_pop | fips + year, allcomp, se = 'twoway'),
       "Model 13 CC" = feols(diff_employed ~ prod_diff + lag_prod_diff + log_realgdp + log_pop | fips + year, allcomp_cc, se = 'twoway'))

# ----- on interaction between rural-urban code
etable("Model 14" = feols(diff_uer ~ prod_diff + lag_prod_diff + prod_diff:ruc_bin +
               lag_prod_diff:ruc_bin + diff_log_realgdp_pc | fips + year, allcomp, se = 'twoway'),
       "Model 14 CC" = feols(diff_uer ~ prod_diff + lag_prod_diff + prod_diff:ruc_bin +
               lag_prod_diff:ruc_bin + diff_log_realgdp_pc | fips + year, allcomp_cc, se = 'twoway'),
       "Model 15" = feols(diff_employed ~ prod_diff + lag_prod_diff + prod_diff:ruc_bin +
               lag_prod_diff:ruc_bin + log_realgdp + log_pop | fips + year, allcomp, se = 'twoway'),
       "Model 15 CC" = feols(diff_employed ~ prod_diff + lag_prod_diff + prod_diff:ruc_bin +
               lag_prod_diff:ruc_bin + log_realgdp + log_pop | fips + year, allcomp_cc, se = 'twoway'))
```


# Overall Economy Model
Coefficient interpretation....mines_diff impact on CHANGE in UER and CHANGE in LOG of emp, unemp, lf, and pop. Does this mean that the coefficient on mines_diff translates to "a one-unit increase in mines is correlated with a x% increase in the CHANGE in log of emp, unemp, lf and pop."

Isn't the question we want to answer the impact of mines_diff on the log of emp, unemp, lf, pop? Or are we comparing the change in the CHANGE in log of emp, etc compared to mean change?
```{r, overall economy model}
model_uer <- feols(FE_diffuer, allcomp, se = 'twoway')
model_emp <- feols(diff_log_employed ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp + diff_log_pop | fips + year, allcomp, se = 'twoway')
model_unemp <- feols(diff_log_unemployed ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp + diff_log_pop | fips + year, allcomp, se = 'twoway')
model_lf <- feols(diff_log_lf ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp + diff_log_pop | 
               fips + year, allcomp, se = 'twoway')
model_pop <- feols(diff_log_pop ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp | 
               fips + year, allcomp, se = 'twoway')

model_uercc <- feols(FE_diffuer, allcomp_cc, se = 'twoway')
model_empcc <- feols(diff_log_employed ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp + diff_log_pop | fips + year, allcomp_cc, se = 'twoway')
model_unempcc <- feols(diff_log_unemployed ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp + diff_log_pop | fips + year, allcomp_cc, se = 'twoway')
model_lfcc <- feols(diff_log_lf ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp + diff_log_pop | 
               fips + year, allcomp_cc, se = 'twoway')
model_popcc <- feols(diff_log_pop ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp | 
               fips + year, allcomp_cc, se = 'twoway')


etable("Model 1"= model_uer,
       "Model 2" = model_emp,
       "Model 3" = model_unemp,
       "Model 4" = model_lf,
       "Model 5" = model_pop)

# Performs same regressions on subset of coal counties only (defined as counties 
# that have had active mines between 2002-2019).
etable("Model 1 CC"= model_uercc,
       "Model 2 CC" = model_empcc,
       "Model 3 CC" = model_unempcc,
       "Model 4 CC" = model_lfcc,
       "Model 5 CC" = model_popcc)

model_list = list(model_uer, model_emp, model_unemp, model_lf, model_pop)
var_rows <-  c("Dependent Var.:", "Change Active Mines","Change Active Mines (t-1)","Change Active Mines (t-2)")

# econ_df <- data.frame(matrix(nrow = 4))
# for(k in 1:length(model_list)){
#   model = etable(model_list[k])
#   save_short <- subset(model, rownames(model) %in% var_rows)
#   econ_df <- cbind(econ_df, save_short)
# }
# econ_df
# test <- as.matrix(pvalue(model_emp)[1:3])

econ_df <- as.data.frame(rbind(create_cols(model_uer), create_cols(model_emp), create_cols(model_unemp), create_cols(model_lf), create_cols(model_pop)))
colnames(econ_df) <- c("t", "t-1", "t-2")
econ_df$model <- c("UER", "EMP", "UNEMP", "LF", "POP")
econ_dflong <- pivot_longer(econ_df, !model, names_to = "time", values_to = "fill")
#econ_dflong$fill <- as.factor(econ_dflong$fill)
econ_dflong$fill[which(econ_dflong$fill == 0)] <- NA
# writexl::write_xlsx(econ_dflong, here("data/"fulleconomydf.xlsx"))
ggplot(econ_dflong, aes(x = time, y = model, fill = fill))+
  scale_y_discrete(limits = rev(c("UER", "EMP", "UNEMP", "LF", "POP")), labels = rev(c("\u0394 UER","\u0394 (log) Employed persons", "\u0394 (log) Unemployed persons", "\u0394 (log) Labour force", "\u0394 (log) Population")))+
  scale_x_discrete(limits = c("t", "t-1", "t-2"), labels = c("0","+1", "+2"))+
    geom_tile(color = "white",
            lwd = 1.5,
            linetype = 1)+
  scale_fill_gradientn(colours=c("navy","royalblue","lightskyblue","white", "mistyrose","red", "darkred"),limits = c(-4,4), na.value = "grey98", labels = c("(-)***","(-)**", "(+/-)*", "(+)**","(+)***"),labs(colour="Sign and Significance Level", size = 0.1))+
  ylab("Outcome Variable")+ 
  xlab("# years following mine closure")+
  theme(panel.background = element_blank(), panel.border = element_blank(), legend.title=element_text(size=8), )

```


## Effect of REE investments: {.tabset}
*Research Question: Do proximate renewable energy investments impact county-level employment impacts of mine closures?*

Employs standard two-way fixed effects panel regressions with county-clustered standard errors to a panel dataset of 3,072 contiguous counties observed between 2002-2019.
Interacts binary indicator for whether the total number of active mines in a county decreased from the previous year and whether REE investments exceeded 0.1% of county GDP.

Results:
1. No statistically significant impact of renewable energy investments detected.

```{r}
summary(allcomp$REE_inv_scaled_realgdp[allcomp$REE_inv_scaled_realgdp != 0])

#7728 observations of non-zero REE. 13.9% of observations have non-zero REE
# 460 observations have investment >= 1*county real GDP (8 also with active mines)
# 75 observations have investment >= 10*county real GDP
# 6 observations have investment >= 100*county real GDP
# 1st quartile upper limit is 0.0049* county real GDP

### 465 observations in coal subset with 162 with mines_diff != 0
test <- subset(allcomp, REE_inv_scaled_realgdp != 0)
quantile(test$REE_inv_scaled_realgdp, probs = seq(.1, .9))
summary(test$REE_inv_scaled_realgdp)
hist(test$REE_inv_scaled_realgdp[test$REE_inv_scaled_realgdp < 1], breaks = 100)

##### Preferable to use indicator for whether ANY REE as only 162 observations?
##### (of 7728 with REE investments) have non-zero mines_diff
## Went with top 10th percentile of data (7020 observations 152 with non-zero mines_diff)

etable("REE Model" = feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 + mines_diff:REE_bin_top90 +
                             lag_diff:REE_bin_top90 + lag_diff2:REE_bin_top90 + REE_bin_top90 + diff_log_realgdp_pc | fips + year, allcomp,  se = 'twoway'),
       "REE Model CC" = feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 + mines_diff:REE_bin_top90 +
                             lag_diff:REE_bin_top90 + lag_diff2:REE_bin_top90 + REE_bin_top90 + diff_log_realgdp_pc | fips + year, allcomp_cc,  se = 'twoway'), tex = TRUE, signifCode = c(`***` = 0.001, `**` = 0.01, `*` = 0.05, . = 0.1))

ree_model_main = feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 + mines_diff:REE_bin_top90 +
                             lag_diff:REE_bin_top90 + lag_diff2:REE_bin_top90 + REE_bin_top90 + diff_log_realgdp_pc | fips + year, allcomp,  se = 'twoway')

etable(feols(diff_uer ~ mines_diff + mines_diff:REE_bin_top90 + mines_diff:l(REE_bin_top90, 1) + mines_diff:l(REE_bin_top90, 2) + diff_log_realgdp_pc | fips + year, allcomp, panel.id = ~fips+year,se = 'twoway'),
       feols(diff_uer ~ mines_diff + mines_diff:REE_bin_top90 + diff_log_realgdp_pc | fips + year, allcomp, panel.id = ~fips+year,se = 'twoway'),
       feols(diff_uer ~ mines_diff + mines_diff:l(REE_bin_top90, 1) + diff_log_realgdp_pc | fips + year, allcomp, panel.id = ~fips+year,se = 'twoway'),
       feols(diff_uer ~ mines_diff + mines_diff:l(REE_bin_top90, 2) + diff_log_realgdp_pc | fips + year, allcomp, panel.id = ~fips+year,se = 'twoway'))

etable(feols(diff_uer ~ lag_diff2 + diff_log_realgdp_pc | fips + year, allcomp, panel.id = ~fips+year,se = 'twoway'),
       feols(diff_uer ~ lag_diff2 + lag_diff2:l(REE_bin_top90, 1) + diff_log_realgdp_pc | fips + year, allcomp, panel.id = ~fips+year,se = 'twoway'),
       feols(diff_uer ~ lag_diff2 + lag_diff2:l(REE_bin_top90, 2) + diff_log_realgdp_pc | fips + year, allcomp, panel.id = ~fips+year,se = 'twoway'),
       feols(diff_uer ~ lag_diff2 + lag_diff2:l(REE_bin_top90, 2) + lag_diff2:l(REE_bin_top90, 1) + diff_log_realgdp_pc | fips + year, allcomp, panel.id = ~fips+year,se = 'twoway'), signifCode = c(`***` = 0.001, `**` = 0.01, `*` = 0.05, . = 0.1))
```


```{r, eval = FALSE, include = FALSE}
### Include specification with state-level renewable energy investment data
allcomp$REE_state_bin <- ifelse(allcomp$REE_inv_state != 0, 1, 0)
allcomp_cc$REE_state_bin <- ifelse(allcomp_cc$REE_inv_state != 0, 1, 0)

etable("REE Model" = feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 + mines_diff:REE_bin_top90 +
                             REE_bin_top90 + mines_diff:REE_state_bin + diff_log_realgdp_pc | fips + year, allcomp,  se = 'twoway'),
       "REE Model CC" = feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 + REE_state_bin + diff_log_realgdp_pc | fips + year, allcomp_cc,  se = 'twoway'))

glht(ree_model_main, linfct = "mines_diff + lag_diff + lag_diff2 = 0") %>% summary
glht(ree_model_main, linfct = "mines_diff + lag_diff + lag_diff2 + mines_diff:REE_bin_top90 + lag_diff:REE_bin_top90 + lag_diff2:REE_bin_top90 = 0") %>% summary
```

# Spatial models
## Spatial models {.tabset}
### Tests for cross-sectional dependence 
Cross-sectional dependence detected. Moran's I test and lagrange multiplier tests remain to be run!

```{r, eval = FALSE}
##############################################################
# library(lmtest)
# mainplm <- plm(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc, allcomp_full, effect="twoways", index = c("fips","year"))

# Confirms fixed effects is the way to go
phtest(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc, 
        data = allcomp_full, effect = "twoways", index = c("fips", "year"),
        test = c("cd", "sclm", "bcsclm", "lm", "rho", "absrho"),
        w = fmat)

# Confirms presence of cross sectional dependence
tests <- c("cd", "lm", "sclm", "rho", "absrho")

cdtest <- lapply(tests,function(x) pcdtest(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc, 
        data = allcomp_full, effect = "twoways", index = c("fips", "year"),
        test = x,
        w = fmat))

# Randomization-based test of spatial dependence for panel models
# All of the following confirm cross-sectional dependence robust to global 
# dependence by common factors and persistence (serial correlation) in the data (Millo 2017)
#"rho" for the average correlation coefficient
# These return identical results...why?

rwtest(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc, 
        data = allcomp_full, test = "rho", w = fmat, effect = "twoways", index = c("fips", "year"))
# "cd" for Pesaran's CD statistic
rwtest(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc, 
        data = allcomp_full, test = "cd", w = fmat, effect = "twoways", index = c("fips", "year"))

# "sclm" for the scaled version of Breusch and Pagan's LM statistic,
rwtest(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc, 
        data = allcomp_full, test = "sclm", w = fmat, effect = "twoways", index = c("fips", "year"))


# Below not required
# 
# sphtest(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc, data = allcomp_full, effect = "twoways", listw = fmatlw, spatial.model = "error", method = "ML")
# sphtest(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc, data = allcomp_full, effect = "twoways", listw = fmatlw, spatial.model = "lag", method = "ML")
# sphtest(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc, data = allcomp_full, effect = "twoways", listw = fmatlw,spatial.model = "sarar",method = "ML")


# MORAN'S I TEST
#moran.lm<-lm.morantest(allcomp_full$diff_uer, fmatlw, alternative="two.sided")


# Vetor memory exhausted
# LAGRANGE MULTIPLIER TEST
# Locally robust LM tests for spatial lag (error) correlation sub spatial error (lag) correlation in panel models
#slmtest(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc,
#        data = allcomp_full, listw = fmatlw, test="lme", model="within")
#slmtest(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc,
#        data = allcomp_full, listw = fmatlw, test="lml", model="within")
#slmtest(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc,
#        data = allcomp_full, listw = fmatlw, test="rlme", model="within")
#slmtest(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc,
#        data = allcomp_full, listw = fmatlw, test="rlml", model="within")

# Moran test
# Moran test for residuals:
# moran.test(as.data.frame(sp_err_mines$residuals), listw = fmatlw)

```

```{r, cache = TRUE}
# This does not include 7 LA counties for which no employment indicators 
# were recorded in 2005 and 2006. Therefore, use allcomp_full as created 
# in the spatial matrix initiation section.

# Broomfield County, Colorado was only created in 2001 so no observation 
# exists for 2001 - will replace with 0 for completeness. It is only the 
# first observation...

allcomp_full$diff_log_realgdp_pc[which(allcomp_full$fips == "08014" & allcomp_full$year == 2002)] <- 0
allcomp_full$diff_log_realgdp[which(allcomp_full$fips == "08014" & allcomp_full$year == 2002)] <- 0
allcomp_full$diff_log_pop[which(allcomp_full$fips == "08014" & allcomp_full$year == 2002)] <- 0

fmdiff_uer <- diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc

# Required to extract Log Likelihood of error and SARAR model
#fixInNamespace("spsararlm", "splm")
#fixInNamespace("sperrorlm", "splm")
# (NOT DONE AS SPLAGLM RETURNS A MEASURE FOR LL) 
#fixInNamespace("splaglm", "splm")
# This third function (which returns a value for loglikelihood, transforms it according to:
# ens <- as.numeric((time * ldet  - ((n*time/2) * log(2 * pi)) - (n*time/2) * log(s2) - 1/(2 * s2) * SSE)) 
# and then returns ens instead of LL.......

#And manually add "ll=LL" as an element to the "return" list at the end of
#the function so that it reads:
#return <- list(coeff = betas, lambda = lambda, s2 = s2, rest.se = rest.se, 
#       lambda.se = lambda.se, asyvar1 = asyvar1, ll=LL)

sp_err_mines <- spml(fmdiff_uer, allcomp_full, 
                     index = NULL,  listw = fmatlw, lag = FALSE, na.action = na.fail, 
                     spatial.error = "b",  model = "within", effect = "twoways", quiet = FALSE)

sp_lag_mines <- spml(fmdiff_uer, allcomp_full, index = NULL,  listw = fmatlw,
                     lag = TRUE, na.action = na.fail,
                     spatial.error = "none",  model = "within", effect = "twoways", quiet = FALSE)

# Only used to test whether unadjusted loglikelihood yields different AIC and BIC results
# sp_lag_mines_unadjll <- spml(fmdiff_uer, allcomp_full, index = NULL,  listw = fmatlw,
#                      lag = TRUE, na.action = na.fail,
#                      spatial.error = "none",  model = "within", effect = "twoways", quiet = FALSE)

sp_err_lag_mines <- spml(fmdiff_uer, data = allcomp_full, index = NULL,  listw = fmatlw, 
                         lag = TRUE, na.action = na.fail, spatial.error = "b",
                         model = "within", effect = "twoways", quiet = FALSE)

# sp_err_mines$logLik
# sp_lag_mines$logLik
# sp_lag_mines_unadjll$logLik
# sp_err_lag_mines$logLik

# summary(sp_err_mines)
# summary(sp_lag_mines)
# summary(sp_lag_mines_unadjll)
# summary(sp_err_lag_mines)

sparse.W <- listw2dgCMatrix(fmatlw)
time <- length(unique(allcomp_full$year))
s.lwcounties <- kronecker(Matrix::Diagonal(time), sparse.W)
trMatc <- spatialreg::trW(s.lwcounties, type="mult")
implag <- spatialreg::impacts(sp_lag_mines, tr = trMatc, R = 200)
imperrlag <- spatialreg::impacts(sp_err_lag_mines, tr = trMatc, R = 200)

summary(sp_err_mines)
summary(implag, zstats=TRUE, short=TRUE)
summary(imperrlag, zstats=TRUE, short=TRUE)

# residuals(sp_lag_mines)
# merged <- allcomp_full %>%
#   mutate(residuals_lag = residuals(sp_lag_mines), residuals_lagerr = residuals(sp_err_lag_mines), residuals_err = residuals(sp_err_mines))
#moran.test(merged$residuals_lag, listw = fmatlw, zero.policy = FALSE)

```


```{r, eval = FALSE, include = FALSE }
# Spatial model summary results
sums <- summary(implag, zstats=TRUE, short=TRUE)
#sums <- summary(imperrlag, zstats=TRUE, short=TRUE)

var_names = c("mines_diff", "lag_diff", "lag_diff2", "diff_log_realgdp_pc")
var_names_ = c("mines_diff", "lag_diff_", "lag_diff2", "diff_log_realgdp_pc")

tab = bind_rows(sums$res) %>% t %>% as.data.frame %>% setNames(., var_names) %>% mutate(Coef_Type=str_to_title(rownames(.)),
         Value_Type="Estimate") %>% bind_rows(sums$semat %>% t %>% as.data.frame %>% 
              mutate(Coef_Type=rownames(.),
                     Value_Type="Simulated SE")) %>% 
  bind_rows(sums$pzmat %>% t %>% as.data.frame %>% 
              mutate(Coef_Type=rownames(.),
                     Value_Type="p_values")) %>% 
   gather(key, value, "mines_diff", "lag_diff", "lag_diff2", "diff_log_realgdp_pc") 

tab1 = tab %>% 
  unite(coef, key, Value_Type) %>% 
  spread(coef, value) %>% 
  select(1,unlist(lapply(var_names_, function(x) grep(x, names(.))))) %>% 
  mutate_if(is.numeric, round, 3)

# Change column names to what we want to see in the output table
names(tab1) = c("", gsub(".*_(.*)", "\\1", names(tab1)[-1]))

# Output latex table, including extra header row to mark coefficient names
# kable(tab1, booktabs=TRUE, format = "latex") %>% 
#   add_header_above(setNames(c("", 3, 3, 3, 3), c("", "Active Mines", "Active Mines (t-1)", "Active Mines (t-2)", "(log) Real GDPPC"))) %>% 
#   kable_styling(position="center")

# Spatial error model output table
sum_sperr <- summary(sp_err_mines) %>% .$CoefTable %>% as.data.frame
names(sum_sperr)[4] <- "p_values"

sperr1 = sum_sperr %>% 
  mutate_at("p_values", function(x) ifelse(x <= 0.001, "***",
                                           ifelse(x > 0.001 & x <= 0.01, "**", 
                                                  ifelse(x > 0.01 & x <= 0.05, "*", 
                                                         ifelse(x > 0.05 & x <= 0.1, ".",""))))) %>%
  mutate_if(is.numeric, round, 3) %>% 
  mutate(Estimate = paste0(Estimate, p_values), var = c("Spatial error parameter", "Active Mines", "Active Mines (t-1)", "Active Mines (t-2)", "(log) Real GDPPC"), se = paste0("(",`Std. Error`,")")) %>%
  select(1,5,6) %>% 
  pivot_longer(!var, names_to = "measure", values_to = "estimate")

#, c("Rho", "Active Mines", "Active Mines (t-1)", "Active Mines (t-2)", "(log) Real GDPPC"))
# kable(sperr1[-2], booktabs=TRUE) %>% 
#   kable_styling(position="center")

```

```{r table1, eval = FALSE, include = FALSE}
# Reshape table into desired output format
tab1 = tab %>% 
  unite(coef, key, Value_Type) %>% 
  spread(coef, value) %>% 
  mutate_if(is.numeric, round, 3)

# Change column names to what we want to see in the output table
names(tab1) = c("", gsub(".*_(.*)", "\\1", names(tab1)[-1]))

# Output latex table, including extra header row to mark coefficient names
# kable(tab1, booktabs=TRUE, format="latex") %>% 
#   add_header_above(setNames(c("", 2, 2), c("", sort(rownames(sums$pzmat))))) %>% 
#   kable_styling(position="center")
```


```{r table2, eval = FALSE, include = FALSE}
# # Linear hypothesis testing
# library(car)
# # Can reject the null hypothesis that mines_diff, mines_diff + lag_diff is different from zero
# linearHypothesis(sp_err_mines, "mines_diff + lag_diff  = 0")
# linearHypothesis(sp_err_mines, "mines_diff + lag_diff +lag_diff2 = 0")
# 
# # CANNOT confidently reject that lag_diff2 does not return to the prior unemployment rate prior to the mine closure.
# linearHypothesis(sp_err_mines, "mines_diff + lag_diff +lag_diff2 = 0")

```

```{r, eval = FALSE, include = FALSE}

sptest = summary(sp_err_mines)
sptest$effects

# MuMIn::AICc(sp_err_mines)
# MuMIn::AICc(sp_lag_mines)
# MuMIn::AICc(sp_err_lag_mines)
# MuMIn::AICc(sp_lag_mines_unadjll)

#logLik, AIC and BIC
# Indicates that the order of preference of the models is as follows: lag, error-lag, lag(unadj), error
sp_lag_mines$logLik
sp_err_lag_mines$logLik
sp_err_mines$logLik
sp_lag_mines_unadjll$logLik

# class(MuMIn::AICc(sp_err_mines))
# sort(c(MuMIn::AICc(sp_err_mines), MuMIn::AICc(sp_lag_mines), MuMIn::AICc(sp_err_lag_mines), MuMIn::AICc(sp_lag_mines_unadjll)))

sp_list <-list(sp_err_mines, sp_lag_mines_unadjll, sp_err_lag_mines)
names(sp_list) = c("sp_error", "sp_lag_unadj", "sp_err_lag")

aic_bic <- cbind(as.data.frame(sapply(sp_list, function(x) x$logLik)), as.data.frame(sapply(sp_list, function(x) AICsplm(x ,criterion = c("AIC")))),
as.data.frame(sapply(sp_list, function(x) AICsplm(x ,criterion = c("BIC"))))) %>% arrange(.[,2])
colnames(aic_bic) <- c(" Log Likelihood", "AIC", "BIC")
rownames(aic_bic) <- c("Spatial Lag-Error Model", "Spatial Lag Model", "Spatial Error Model")
# 
# kable(aic_bic, format = "latex")

```

```{r, cache = TRUE}


sp_err <- dw_compat(sp_err_mines)
sp_lag <- dw_compat_imp(implag)
sp_lag$model <- "Spatial Lag"
sp_errlag <- dw_compat_imp(imperrlag)
sp_errlag$model <- "Spatial Lag & Error"
spat_models <- rbind(sp_err[2:4,], sp_lag[1:3,], sp_errlag[1:3,])
  
# Spatial Durbin model here!
# library(spatialreg)
# lagsarlm(fmdiff_uer, allcomp_LA, listw = fmatlw, na.action = na.fail, Durbin = TRUE)
```

### Employed overall 
```{r, cache = TRUE, eval = FALSE}

fmdiff_employed <- diff_log_employed ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp + diff_log_pop

emp_spat <- spml(fmdiff_employed, data = allcomp_full, index = NULL,  listw = fmatlw, 
                         lag = TRUE, na.action = na.fail, spatial.error = "b",
                         model = "within", effect = "twoways", quiet = FALSE)


impemp_spat <- spatialreg::impacts(emp_spat, tr = trMatc, R = 200)
summary(impemp_spat, zstats=TRUE, short=TRUE)


```

### Unemployed spatial
```{r, cache = TRUE, eval = FALSE}
fmdiff_unemp <- diff_log_unemployed ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp + diff_log_pop

unemp_spat <- spml(fmdiff_unemp, data = allcomp_full, index = NULL,  listw = fmatlw, 
                         lag = TRUE, na.action = na.fail, spatial.error = "b",
                         model = "within", effect = "twoways", quiet = FALSE)

imp_unemp_spat <- spatialreg::impacts(unemp_spat, tr = trMatc, R = 200)
summary(imp_unemp_spat, zstats=TRUE, short=TRUE)

```

### Labour force spatial
```{r, cache = TRUE, eval = FALSE}

fmdiff_lf <- diff_log_lf ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp + diff_log_pop
lf_spat <- spml(fmdiff_lf, data = allcomp_full, index = NULL,  listw = fmatlw, 
                         lag = TRUE, na.action = na.fail, spatial.error = "b",
                         model = "within", effect = "twoways", quiet = FALSE)

imp_lf_spat <- spatialreg::impacts(lf_spat, tr = trMatc, R = 200)
summary(imp_lf_spat, zstats=TRUE, short=TRUE)
```

### Population spatial
```{r, cache = TRUE, eval = FALSE}
fmdiff_pop <- diff_log_pop ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp
pop_spat <- spml(fmdiff_pop, data = allcomp_full, index = NULL,  listw = fmatlw, 
                         lag = TRUE, na.action = na.fail, spatial.error = "b",
                         model = "within", effect = "twoways", quiet = FALSE)

imp_pop_spat <- spatialreg::impacts(pop_spat, tr = trMatc, R = 200)
summary(imp_pop_spat, zstats=TRUE, short=TRUE)
```

### Table of calculated impacts of overall economy spatial models (SARAR)
```{r, cache = TRUE, eval = FALSE}
tab2 <- cbind(spat_output(impemp_spat)[-4], 
      spat_output(imp_unemp_spat)[-4],
      spat_output(imp_lf_spat)[-4],
      spat_output(imp_pop_spat)[-4])

kable(tab2[,1:6], booktabs=TRUE, format = "latex") %>%
  add_header_above(setNames(c("", 3, 3), c("", "Employed Persons", "Unemployed Persons"))) %>%
  kable_styling(position="center")

kable(tab2[,7:12], booktabs=TRUE, format = "latex") %>%
  add_header_above(setNames(c("", 3, 3), c("", "Labour Force", "Population"))) %>%
  kable_styling(position="center")

```


# (Potential) useful figures/maps {.tabset}
### SSR
Don't see immediate cause for concern? Perhaps some clustering in the southwest/appalachia but the counties themselves are also smaller in size so might optically trick?
```{r}

glht(main, linfct = "mines_diff + lag_diff + lag_diff2 = 0") %>% summary
glht(main_cc, linfct = "mines_diff + lag_diff + lag_diff2 = 0") %>% summary

ssr_df <- allcomp %>% slice(main$obs_selection$obsRemoved) %>% mutate(residuals = main$residuals) %>%
  group_by(fips) %>%
  summarise(ssr = sum(residuals^2))

allcompva <- df_va(allcomp)

ssr_df_va <- df_va(ssr_df)
plot_usmap(data = ssr_df_va, values = "ssr", regions = "counties", col = "black", size = 0.07, exclude = c("AK", "HI" )) +
  labs(title = "Geographical Distribution of SSR") + 
  scale_fill_viridis(name = "ssr",  na.value = "seashell2") +
  theme(panel.background = element_rect(colour = "black", fill = "gray90"))

hist(ssr_df$ssr)

```

### UER
```{r}

means_overall <- allcomp %>% 
   group_by(fips) %>%
   summarize(uer = mean(uer), REE_scaled = sum(REE_inv_scaled_realgdp))

means_overallva <- df_va(means_overall)

hist(allcompva$mines_diff[allcompva$mines_diff != 0])
summary(allcompva$mines_diff[allcompva$mines_diff != 0])

plot_usmap(data = filter(allcompva, year == 2019), values = "uer", regions = "counties", col = "black", size = 0.07, exclude = c("AK", "HI" )) +
   labs(title = "Geographical Distribution of Unemployment Rate in 2019") + 
   scale_fill_viridis(name = "uer", na.value = "seashell2", direction = -1, option = "magma") +
   theme(panel.background = element_rect(color = "black", fill = "gray90"), legend.position = "left")

```

### UER over time
This would ideally be animated or grid arranged but have not yet figured it out :)
```{r}
# Goal: animate or grid.arrange
uer_list = list()
for(i in 2002:2019){
   j = i - 2001
   p1 <- plot_usmap(data = filter(allcompva, year == i), values = "uer", regions = "counties", col = "black", size = 0.07, exclude = c("AK", "HI" )) +
     labs(title = paste0("Geographical Distribution of Unemployment Rate in ", i)) + 
     scale_fill_viridis(name = "uer",  na.value = "seashell2", direction = -1) +
     theme(panel.background = element_rect(color = "black", fill = "gray90"), legend.position = "left")
   print(p1)
   uer_list[[j]] <- p1
}
```

### Other indicators over time
```{r}
yearsums <- allcomp %>%
  group_by(year) %>%
  summarize(REE = sum(REE_inv), TAA = sum(total_taa), active_mines = sum(active_mines), 
            mines_diff = sum(mines_diff), uer = mean(uer), emp = sum(emp), 
            employed = sum(employed), unemployed = sum(unemployed), 
            labour_force = sum(labour_force), labor_hours = mean(labor_hours, na.rm = TRUE))

yearsums$uercalc <- (yearsums$unemployed/yearsums$labour_force)*100

reeplot <- ggplot(yearsums, aes(x=year, y=REE)) +
  geom_line()+
  geom_point()+
  labs(title="Renewable energy investments between 2002-2019",x="Year", y = "Renewable Energy Investments")+
  scale_color_viridis(option = "D") +
  scale_fill_viridis(option = "D")

taaplot <- ggplot(yearsums, aes(x=year, y=TAA)) +
  geom_line()+
  geom_point()+
  labs(title="TAA funding between 2002-2019",x="Year", y = "Renewable Energy Investments")

mines_diffplot <- ggplot(yearsums, aes(x=year, y=mines_diff)) +
  geom_line()+
  geom_line(linetype = "dashed", aes(y = 0))+
  geom_point()+
  labs(title="Change in active mines between 2002-2019",x="Year", y = "Change in active mines")

mines_diff_cty <- ggplot(allcomp, aes(x=year, y = mines_diff)) +
  geom_jitter(aes(color = state.x))+
  geom_point(aes(y = max(mines_diff)))+
  labs(title="Change in active mines between 2002-2019",x="Year", y = "Change in active mines")


emp_lfplot <- ggplot(yearsums, aes(x = year)) +
  geom_line(aes(y = employed, color = "Employed persons")) +
  geom_line(aes(y = labour_force, color = "Labour force"))+
  theme(legend.position = "bottom")+
  labs(title="Employed, Labour Force",x="Year")

unemp_plot <- ggplot(yearsums, aes(x = year, y = labour_force)) +
  geom_line(aes(y = labour_force, color = "Labour force"))+
  theme(legend.position = "bottom")+
  labs(title="Unemployed Persons",x="Year")

uerplot <-ggplot(yearsums, aes(x = year, y = uercalc)) +
  geom_line()+
  theme(legend.position = "bottom")+
  labs(title="National unemployment rate",x="Year")

mines_emp <- ggplot(yearsums, aes(x = year)) +
  geom_line(aes(y = active_mines, color = "Active Mines")) +
  geom_line(aes(y = emp/100, color = "Persons Employed in Coal")) +
  scale_y_continuous(
    name = "Active Mines",
    sec.axis = sec_axis(~.*100, name="Persons Employed in Coal (Hundreds)")
  ) +
  theme(legend.position = "bottom",
    legend.title = element_blank(),
    axis.title.y = element_text(size=13, face = "italic", hjust = 0.5),
    axis.title.y.right = element_text(size=13, face = "italic", hjust = 0.5),
    title = element_text(size = 12)
  ) +
  scale_color_viridis(discrete = TRUE, direction = -1)

grid.arrange(reeplot, taaplot, mines_diffplot, mines_emp, ncol=2, nrow =2)
grid.arrange(uerplot, emp_lfplot, unemp_plot, ncol=2, nrow =2)
```

# Interactive Fixed Effects/Factor Structure Efforts 
## {.tabset}
### Testing for presence of unobserved common factors
Confirmed!
```{r}
library(phtt)

# Create matrices of most often used variables
dep_diff_uer <- c_mat(allcomp$diff_uer)
ind_mines_diff <- c_mat(allcomp$mines_diff)
ind_lag_diff <- c_mat(allcomp$lag_diff)
ind_lag_diff2 <- c_mat(allcomp$lag_diff2)
# ind_closure <- c_mat(allcomp$mine_closure)
# ind_lag_closure <- c_mat(allcomp$lag_closure)
ind_difflogrealgdppc <- c_mat(allcomp$diff_log_realgdp_pc)
ind_difflogrealgdp <- c_mat(allcomp$diff_log_realgdp)
ind_difflogpop <- c_mat(allcomp$diff_log_pop)
dep_logemp <- c_mat(allcomp$diff_log_employed)
dep_logunemp <- c_mat(allcomp$diff_log_unemployed)
dep_loglf <- c_mat(allcomp$diff_log_lf)
dep_logpop <- c_mat(allcomp$diff_log_pop)

################################################################################
# Test for potential interactive FE (beyond additive two-ways fixed effects) as 
# outlined in R package documentation. Result: "Both models have time-varying 
# interactive effects"

# Optimal dimensions = 3 (?) judging by the plots below
fm = dep_diff_uer ~ -1 + ind_mines_diff + ind_lag_diff + ind_lag_diff2 + ind_difflogrealgdppc

test_eup <- Eup(dep_diff_uer ~ -1 + ind_mines_diff + ind_lag_diff + ind_lag_diff2 + ind_difflogrealgdppc , additive.effects = "twoways")
test_kss <- KSS(dep_diff_uer ~ -1 + ind_mines_diff + ind_lag_diff + ind_lag_diff2 + ind_difflogrealgdppc , additive.effects = "twoways")

# Both tests confirm existence of time-varying interactive effects
checkSpecif(test_eup, level = 0.001)
checkSpecif(test_kss, level = 0.001)

################################################################################
OptDim(test_eup, criteria = c("IPC1", "PC1", "PC2"), standardize = TRUE)
plot(OptDim(test_kss, standardize = TRUE), main = NULL, xlab = "Proposed # of Factors")
                                                  
#"Scree Plot: Optimal Factor Choices Reported by Various Factor/Principal Component Analysis Methods"))
# Removing LA counties removes 4-factor suggestion. Only 1 or 2

# kable(test_kss$optimal.dim)

```

### Individual effects only
In preliminary application of phtt package with two-way fixed effects, the third forced factor seemed to follow the behavior of the time-fixed effect. Thus, individual fixed effects were attemped (instead of two-way) with 2,3,4 factors included. However, plotting estimated factors (see plots below) shows that the time-fixed effect 'disappears' (ie. is not accounted for) as the forced factors no longer take up the time-fixed effect behavior of the dependent variable. Thus, I assume that two-way fixed effects is still the way to go with this model. Below, included individual fixed effects models with 2,3,4 factors in case of interest.
```{r phtt efforts without REE Ind}
#| fig.width: 9
#| fig.height: 5

# None of the factors replicate the time fixed effect...thus unlikely that "individual" is the way to go??
# KSS estimation with individual effects only and 2, 3, 4 factors
change1_KSS <- KSS(dep_diff_uer ~ -1 + ind_mines_diff + ind_lag_diff + ind_lag_diff2 + ind_difflogrealgdppc, additive.effects = "individual", factor.dim = 1)
change2_KSS <- KSS(dep_diff_uer ~ -1 + ind_mines_diff + ind_lag_diff + ind_lag_diff2 + ind_difflogrealgdppc, additive.effects = "individual", factor.dim = 2)

saved <- summary(change1_KSS)
saved$
plot(summary(change2_KSS))
summary(change2_KSS)
plot(summary(change2_KSS))

fixInNamespace("KSS.default","phtt")


```


```{r phtt efforts without REE Ind comp}

KSS_ind1 <- dw_compat_kss(change1_KSS)
KSS_ind2 <- dw_compat_kss(change2_KSS)

ife_ind_models <- rbind(KSS_ind1[1:3,], KSS_ind2[1:3,])

```
### Two-way effects
Employing factor structure models using two-way fixed effects yield the following results.

Results:

1. Again, these models corroborate the magnitude and direction of regression coefficients in Models 1 and 1 CC. 
```{r phtt efforts without REE TW}
#| fig.width: 9
#| fig.height: 5
# KSS estimation with individual effects only and 1,2 factors
change1_KSStw <- KSS(dep_diff_uer ~ -1 + ind_mines_diff + ind_lag_diff + ind_lag_diff2 + ind_difflogrealgdppc, additive.effects = "twoways", factor.dim = 1)
change3_KSStw <- KSS(dep_diff_uer ~ -1 + ind_mines_diff + ind_lag_diff + ind_lag_diff2 + ind_difflogrealgdppc, additive.effects = "twoways", factor.dim = 3)

# Results: Regressing UER on change in active mines (+lag) using KSS specification 
# with 2,3,4 factors
# fixInNamespace("summary.KSS", "phtt")
# # Return ee
# n = 55422
# # 
# test1 <- summary(change1_KSStw)
# (1 + log(test1$RSS) +log((2*pi)/n))*(-1*(n/2))
# test2 <- summary(change2_KSStw)
# (1 + log(test2$RSS) +log((2*pi)/n))*(-1*(n/2))

# SSR increase after nfactors = 1.
# To report: 1,2 dimensions

# tabletest <- cbind(tablefun(test1), select(tablefun(test2), c(3)))
# tabletest
# names(tabletest)[3] <- "Factor_1"
# names(tabletest)[4] <- "Factor_2"

# kable(tabletest, booktabs=TRUE, format = "latex") %>% 
#    add_header_above() %>% 
#    kable_styling(position="center")

```


```{r phtt efforts without REE TW comp}
KSS_tw1 <- dw_compat_kss(change1_KSStw)
KSS_tw2 <- dw_compat_kss(change2_KSStw)

ife_tw_models <- rbind(KSS_tw2[1:3,],KSS_tw1[1:3,])

ife_tw_models$term <- substr(ife_tw_models$term, 5, nchar(ife_tw_models$term))

```

### IFE Application of Overall Economy Model
```{r}

emp_KSS <- KSS(dep_logemp ~ -1 + ind_mines_diff + ind_lag_diff + ind_lag_diff2 + ind_difflogrealgdp + ind_difflogpop, additive.effects = "twoways", factor.dim = 1)
unemp_KSS <- KSS(dep_logunemp ~ -1 + ind_mines_diff + ind_lag_diff + ind_lag_diff2 + ind_difflogrealgdp + ind_difflogpop, additive.effects = "twoways", factor.dim = 1)
lf_KSS <- KSS(dep_loglf ~ -1 + ind_mines_diff + ind_lag_diff + ind_lag_diff2 + ind_difflogrealgdp + ind_difflogpop, additive.effects = "twoways", factor.dim = 1)
pop_KSS <- KSS(dep_logpop ~ -1 + ind_mines_diff + ind_lag_diff + ind_lag_diff2 + ind_difflogrealgdp, additive.effects = "twoways", factor.dim = 1)

mergedecon <- cbind(tablefun(summary(emp_KSS))[-2],
               tablefun(summary(unemp_KSS))[3],
                        tablefun(summary(lf_KSS))[3],
                                 rbind(tablefun(summary(pop_KSS)),NA,NA)[3])


kable(mergedecon, booktabs=TRUE, format = "latex") %>%
  add_header_above(c("Variables", "Employed Persons", "Unemployed Persons", "Labour Force", "Population")) %>%
  kable_styling(position="center")

```



### (Ignore atm) PHTT: Replicate regressions incorporating REE interactions
Run on principal regressions with binary mine closure indicator incorporating 
USDA REE investment interaction.

Note: Interaction variables created above via static multiplication of REE 
       binary closure, and lag of binary closure variables. This could 
       potentially pose an issue with SE?

```{r phtt with REE}
#| fig.width: 9
#| fig.height: 5
################################################################################
# Incorporating interaction between REE investments and whether there was a 
# mine closure in that year.

allcomp$intREE = allcomp$REE_bin_top90*allcomp$mines_diff
allcomp$intREElag = allcomp$REE_bin_top90*allcomp$lag_diff
allcomp$intREElag2 = allcomp$REE_bin_top90*allcomp$lag_diff2

test_REE_KSS <- KSS(dep_diff_uer ~  -1 + ind_mines_diff + ind_lag_diff + ind_lag_diff2 + c_mat(allcomp$REE_bin_top90) +
                    c_mat(allcomp$intREE) + c_mat(allcomp$intREElag) + c_mat(allcomp$intREElag2)+ 
                    ind_difflogrealgdppc, 
                    additive.effects = "twoways")

checkSpecif(test_REE_KSS, level = 0.001)
# Rejects null of cross-sectional independence
# Test OptDim: reveals 1,2,4 factors
OptDim(test_REE_KSS, standardize = TRUE)

################################################################################


reebin1_KSS <- KSS(dep_diff_uer ~ -1 + ind_mines_diff + ind_lag_diff + ind_lag_diff2 + c_mat(allcomp$REE_bin_top90) +
                    c_mat(allcomp$intREE) + c_mat(allcomp$intREElag) + c_mat(allcomp$intREElag2)+ 
                    ind_difflogrealgdppc, 
                    additive.effects = "twoways", factor.dim = 1)

reebin2_KSS <- KSS(dep_diff_uer ~ -1 + ind_mines_diff + ind_lag_diff + ind_lag_diff2 + c_mat(allcomp$REE_bin_top90) +
                    c_mat(allcomp$intREE) + c_mat(allcomp$intREElag) + c_mat(allcomp$intREElag2)+ 
                    ind_difflogrealgdppc, 
                    additive.effects = "twoways", factor.dim = 2)

# Results: Regressing UER on mines_diff (+2 time lags) and each of these
# interacted with a binary of whether there was USDA-reported renewable energy investment using 
# KSS specification and 2,3,4 factors
# testree1 <- summary(reebin1_KSS)
# round(testree1$R2, 3)
# testree1$KSS.obj
# (1 + log(testree1$RSS) +log((2*pi)/n))*(-1*(n/2))
# testree2 <- summary(reebin2_KSS)
# (1 + log(testree2$RSS) +log((2*pi)/n))*(-1*(n/2))
# 
# tabletest <- cbind(tablefun(testree1), select(tablefun(testree2), c(3)))
# names(tabletest)[3] <- "Factor_1"
# names(tabletest)[4] <- "Factor_2"
# names(tabletest)
# 
# totaltbl <- rbind(tabletest, data.frame(var = NA,measure = NA, Factor_1 = c(round(testree1$R2, 3), "two-ways", 1),
# Factor_2 = c(round(testree2$R2, 3), "two-ways", 2)))
# testree1

# kable(totaltbl[-2], booktabs=TRUE, format = "latex") %>%
#   add_header_above() %>%
#   kable_styling(position="center")

```

# Coefficient Plots

Results:

1. Main results displayed in coefficient plots show that each model employed for the relationship between the change in active mines and change in unemployment rate estimate the same direction and magnitude of the regression coefficients on the change in active mines regressor (t = t and 1 or 2 time lags). Useful or non-interesting?

## {.tabset}
### FEOLS (General)
```{r}
# Coefficient plots of FEOLS
models <- list(
  "Total US Counties (FEOLS)" = feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc | fips + year, allcomp, se = 'twoway'),
  "Coal Counties Only (FEOLS)" = feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc | fips + year, allcomp_cc, se = 'twoway'))


modelplot(models, coef_map = cm, background = list(geom_vline(xintercept = 0, color = "grey")))+
   labs(x = 'Coefficients (Δ Unemployment Rate)', 
         title = 'Coefficient estimates of FEOLS models')+
    scale_color_manual(values =  viridis(n = 4))+
  theme(panel.background = element_rect("white"))

```

### Spatial models
```{r}
# Coefficient plots of spatial models

full <- tidy(feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc | fips + year, allcomp, se = 'twoway'))
full$model <- "FEOLS (Total US)"
cc <- tidy(feols(diff_uer ~ mines_diff + lag_diff + lag_diff2 + diff_log_realgdp_pc | fips + year, allcomp, se = 'twoway'))
cc$model <- "FEOLS (Coal Counties Only)"
full <- subset(full, term != "diff_log_realgdp_pc")
cc <- subset(cc, term != "diff_log_realgdp_pc")
full_cc <- rbind(subset(cc, term != "diff_log_realgdp_pc"), subset(full, term != "diff_log_realgdp_pc"))

allmodels <- rbind(spat_models, full_cc[c("estimate", "std.error","model","term")], ife_tw_models)
allmodelssave <- read_excel(here("data/coefplotdf.xlsx"))
dwplot(allmodelssave, vline = geom_vline(
           xintercept = 0,
           colour = "grey50"
       )) %>% relabel_predictors(
        c(
            mines_diff = "Δ Active Mines",
            lag_diff = "Δ Active Mines (t-1)",
            lag_diff2 = "Δ Active Mines (t-2)"
        )) +
  labs(x = 'Estimates and 95% Confidence Intervals'
       )+
  scale_color_manual(values =  viridis(n = 8), name = "Model Type")+
  theme(panel.background = element_rect(fill = "white"),
  panel.grid.major = element_line(size = 0.1, linetype = 'solid',
                                colour = "gray"))
  
```

### IFE Factor Models
```{r}
# Coefficient plots of IFE models with individual fixed effects only
# Likely incorrect as the additional factors do not mirror the TFE
dwplot(ife_ind_models, vline = geom_vline(
           xintercept = 0,
           colour = "grey60"
       )) %>% relabel_predictors(
        c(
            ind_mines_diff = "Δ Active Mines",
            ind_lag_diff = "Δ Active Mines (t-1)",
            ind_lag_diff2 = "Δ Active Mines (t-2)"
        )) +
  labs(x = 'Coefficients (Δ Unemployment Rate) and 95% Confidence Intervals', 
         title = "Coefficient estimates of IFE models")

# Coefficient plots of IFE models with two-way fixed effects
dwplot(ife_tw_models, vline = geom_vline(
           xintercept = 0,
           colour = "grey60"
       )) %>% relabel_predictors(
        c(
            ind_mines_diff = "Δ Active Mines",
            ind_lag_diff = "Δ Active Mines (t-1)",
            ind_lag_diff2 = "Δ Active Mines (t-2)"
        )) +
  labs(x = 'Coefficients (Δ Unemployment Rate) and 95% Confidence Intervals', 
         title = "Coefficient estimates of IFE models")


```
### FEOLS (By County Type)
```{r}
# Coefficient plot of models on subset of Type 1, 2, and 3 counties
modelplot(model_types, coef_map = cm, background = list(geom_vline(xintercept = 0, color = "grey")))+
   labs(x = 'Coefficients (Δ Unemployment Rate)', 
         title = 'Coefficient estimates of FEOLS models') +
  scale_color_manual(values =  viridis(n = 3))
```


```{r, eval = FALSE, include = FALSE}
# Create spatial residual map

# Create visual of spatial residual map over time

# Spatial impulse response function

```

# Summary stats
```{r}
# Total REE (overall and in CC)
# $6,314,520,585 in overall US since 2002
# $122,238,781 in CC counties since 2002 (1.94%)

natlsums <- allcomp %>%
  summarize(REE = sum(REE_inv), TAA = sum(total_taa), mines_diff = sum(mines_diff))

# Total TAA (overall and in CC)
# $655,349,084,590 in overall US since 2009
# $65,952,811,622 in CC counties since 2009 (10.1%)
cc_sum <- allcomp_cc %>%
  summarize(REE = sum(REE_inv), TAA = sum(total_taa))

# Avg mines closed per yer

```
