---
title: "Group Fixed Effects"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(comment = NA, echo = TRUE, eval = TRUE, 
                      warning = FALSE, message = FALSE)
```

```{r packages, echo = FALSE}
library(tidyverse)
library(fixest)
library(readxl)
library(here)
library(multcomp)
library(conflicted)
library(stargazer)
conflict_prefer('coefplot', 'fixest')
conflict_prefer('filter', 'dplyr')

# Set dictionaries and coefplot parameters
source('dicts.R')

fill_colors <- c("#39568CFF", "#95D840FF", "#eb7134")
line_colors <- c("#440154FF", "#287D8EFF", "#eb7134")
setFixest_coefplot(pt.join = TRUE, pt.join.par = list(lwd = 2, lty = c("solid", "dashed", "dashed")),
                   ci.join = TRUE, ci.join.par = list(lty = c("dashed", "blank", "blank"), lwd = 0.5, col = line_colors), ci.fill = TRUE, ci.col = fill_colors,
                   pt.col = line_colors, pt.pch = c(25, 23, 19), pt.bg = line_colors,
                   pt.cex = 1, ci.fill.par = list(col = fill_colors, alpha = 0.1), ci.lwd = 0.5,
                   ci.lty = "blank", ref.line = TRUE, ref.line.par = list(v = 2, col = "gray", lty = "solid"),
                   grid = TRUE, grid.par = list(vert = FALSE, lwd = 1), dict = plot_dict, sep = 0, 
                   main = "Effect of (-) change in active mines on change in county UER", group.par = c(text.font = 'Courier'))
```

## Context

Originally, what we now refer to as the "group fixed effects" version of the standard TWFE OLS Model 1 was just an application of Model 1 to a subset of each county type (brute force which also generates 3 unique sets of county and year fixed effects). But since it is now more extensively explained in our paper (thanks Ryan!) I tried to implement it with more thought. Anyway, I feel comfortable enough with this new estimation strategy that I have replaced our explanation of the results of the brute force application with these new results. The results are very near what was found with the subsetting which is comforting and does not throw off anything else that we report in the Results/Discussion. Any difference in coefficient estimate is because there is no interaction between group and county/year fixed effects (as there was in the subsetting version) and the coefficient slope on the control variable (change log Real GDPPC) does not vary by county type (could consider some testing here...). Of course, given I only figured out how to do this very recently, your eyes for error correction and red flags would be most appreciated.

[For reference, county types are defined follows:]{.underline}

1.  Urban, high-income, high educational attainment...etc.
2.  Medium
3.  Rural, low-income, less educational attainment...etc.

## Data

A subset of the full dataset of all counties that includes only those 251 counties that we define as "coal counties" (ie. had active mines in the time period considered).

```{r data}
# Full dataset
allcomp <- read_excel(here("data/allcomp_final.xlsx"))

# Subset of coal counties
allcomp_cc <- subset(allcomp, fips %in% unique(allcomp$fips[which(allcomp$active_mines != 0)]))

# Merge types identified from clustering work
cc_cluster <- read_excel(here("data/cc_clusters_251.xlsx"))
allcomp_cc_types <- merge(allcomp_cc, cc_cluster, by = "fips", all.x = TRUE) %>% 
  mutate(factor_type = as.factor(type))
```

# Improved GFE Application

## Model Estimation

[In brief, the change made]{.underline}: *fixest* has a functionality for the group fixed effects to account for heterogeneous treatment effects. Each variable you wish to accommodate a varying slope can either be given a 'numerator' of your fixed effect variable or included directly in the fixed effects part of the formula (following '\|') using fe[variable]. The former was chosen as it retains information allowing for a calculation of the confidence interval, unlike the [] option. Below estimated with our "Model 1 ("base") functional form with only two time lags of the principal independent variable of interest and the extended ("base_ext") with an additional lag and lead (as reported in the event study plot).

```{r pressure}
base <- feols(neg_diffuer ~ factor_type/mines_diff + factor_type/lag_diff + 
                factor_type/lag_diff2 + diff_log_realgdp_pc | fips + year, 
                allcomp_cc_types, panel.id = ~fips+year, se = "twoway")

base_ext <- feols(neg_diffuer ~ factor_type/l(mines_diff, -1:0) + 
                factor_type/mines_diff + factor_type/lag_diff + 
                factor_type/lag_diff2 + factor_type/lag_diff3 +
                diff_log_realgdp_pc | fips + year, 
                allcomp_cc_types, panel.id = ~fips+year, se = "twoway")

```

## Event Study Plot

Event study plot of coefficient estimates per county type as estimated using the functionality in the *fixest* package. Compared to the event study plot originally reported from the basic subsetting option, the pattern of response remains consistent for each county type although the magnitude varies slightly.

```{r gfe coefplot, echo = FALSE}

coefplot(list(coeftable(base_ext, keep = "%type3"), coeftable(base_ext, keep = "%type2"), coeftable(base_ext, keep = "%type1")))
legend("topright", legend = c("Type 1 (Least Vulnerable)", "Type 2", "Type 3 (Most Vulnerable)"), col = c( "#eb7134","#287D8EFF","#440154FF"), pt.bg= c( "#eb7134","#287D8EFF","#440154FF"), pch = c(19, 23, 25), cex = 1, 
  text.col = "black", lty = c("dashed", "dashed", "solid"), title = "County Type")

```

## Model Summary Table

```{r gfe table, echo = FALSE}

base <- feols(diff_uer ~ 
                factor_type/mines_diff +
                factor_type/lag_diff + 
                factor_type/lag_diff2 +
                diff_log_realgdp_pc | fips + year,
                allcomp_cc_types, 
                panel.id = ~fips+year, se = "twoway")

base_ext <- feols(diff_uer ~ factor_type/l(mines_diff, -1:0) + 
                factor_type/mines_diff +
                factor_type/lag_diff + 
                factor_type/lag_diff2 +
                factor_type/lag_diff3 +
                diff_log_realgdp_pc | fips + year, 
                allcomp_cc_types, 
                panel.id = ~fips+year, se = "twoway")

knitr::kable(etable("Model 1 w/ GFE" = base, "Model 1 w/GFE extended" = base_ext, order = c('factor_type1', 'factor_type2', 'factor_type3', 'diff'), 
       signif.code = c(`***` = 0.001, `**` = 0.01, `*` = 0.05, . = 0.1)), tex = TRUE)
```

# Original GFE Application

Below find the original estimation (from a while ago) that was reported in the paper when you last read it. This is what I have proposed to replace with the results from above given that the above gives more flexible control over how we wish to vary the coefficient of the control variable as well as retain non-interacted county and year fixed effects.

## Model Estimation

```{r original, echo = TRUE}

# Regression equations
FE_diffuer <- as.formula("diff_uer ~ mines_diff + lag_diff + 
                         lag_diff2 + diff_log_realgdp_pc | fips + year")
FE_negdiffuer <- as.formula("neg_diffuer ~ mines_diff + lag_diff + 
                            lag_diff2 + diff_log_realgdp_pc | fips + year")
FE_neg_full <- as.formula("neg_diffuer ~ l(mines_diff, -1:0) + 
lag_diff + lag_diff2 + lag_diff3 + diff_log_realgdp_pc | fips + year")
FE_pos_full <- as.formula("diff_uer ~ l(mines_diff, -1:0) + 
lag_diff + lag_diff2 + lag_diff3 + diff_log_realgdp_pc | fips + year")

# Create subsets by county
cc_urbandf <- allcomp_cc_types %>% filter(type == 1)
cc_mediumdf <- allcomp_cc_types %>% filter(type == 2)
cc_ruraldf <- allcomp_cc_types %>% filter(type == 3)

# Run regressions using negative dependent variable for correct coefficient interpretation
rural_2neg <- feols(FE_neg_full, cc_ruraldf, panel.id = ~fips+year, se = 'twoway')
medium_2neg <- feols(FE_neg_full, cc_mediumdf, panel.id = ~fips+year, se = 'twoway')
urban_2neg <- feols(FE_neg_full, cc_urbandf, panel.id = ~fips+year, se = 'twoway')

```

## Event Study Plot

```{r original coefplot, echo = FALSE}

coefplot(list(rural_2neg, medium_2neg, urban_2neg),drop = c('diff_log_realgdp_pc'), xlab = "Years since negative change in active mines")
legend("topright", legend = c("Type 1 (Least Vulnerable)", "Type 2", "Type 3 (Most Vulnerable)"), col = c( "#eb7134","#287D8EFF","#440154FF"), pt.bg= c( "#eb7134","#287D8EFF","#440154FF"), title = "County Type", pch = c(19, 23, 25), cex = 1, 
  text.col = "black", lty = c("dashed", "dashed", "solid"))


```

## Model Summary Table

```{r original table, echo = FALSE}

knitr::kable(etable("Type 1" = feols(FE_diffuer, cc_urbandf, se = "twoway"), 
       "Type 1 Ext." = feols(FE_pos_full, cc_urbandf, 
                               panel.id = ~fips+year,se = "twoway"), 
       "Type 2" = feols(FE_diffuer, cc_mediumdf, se = "twoway"), 
       "Type 2 Ext." = feols(FE_pos_full, cc_mediumdf, 
                                panel.id = ~fips+year,se = "twoway"), 
       "Type 3" = feols(FE_diffuer, cc_ruraldf, se = "twoway"), 
       "Type 3 Ext." = feols(FE_pos_full, cc_ruraldf, 
                               panel.id = ~fips+year,se = "twoway"),
       order = c("Change Active Mines"), 
       signif.code = c(`***` = 0.001, `**` = 0.01, `*` = 0.05, . = 0.1)))

```
